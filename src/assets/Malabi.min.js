!function(p,g){var b="malabiEditorModal",t=new function(){var r,s;this.apiUrl="api.malabi.co/v1",this.apiId=null,this.framework="materialize",this.isBootstrap=!1,this.userId=null,this.sessionToken=null,this.sqsRunning=!1,this.malabiEditorText=f,this.iframeElement=null,this.isInit=!1,this.functionArrayToRunAferInit=[],this.settings={},this.editorFrame={};var l="";this.transparent=!1,this.overrideTutorialElement=e,this.injectStyleToIframe=y;var o={exists:function(t,e){var o=new RegExp("(^| )"+e+"( |$)");return t.className&&t.className.match(o)},add:function(t,e){if(this.exists(t,e))return!0;t.className+=" "+e},remove:function(t,e){var o=t.className,a=new RegExp("(^| )"+e+"( |$)");o=o.replace(a," ").replace(/  /g," "),t.className=o}},d=function(){g.getElementById("malabi-loader")?g.getElementById("malabi-loader").style.visibility="hidden":console.error("Error Malabi Init: Loader element not found, looking for #malabi-loader element. Or add your override with your own callbackStopLoader function.")};var m=function(o,t){var e,a,n;"string"==typeof o.local&&(e=t.malabiUrl+"lang/"+o.local+".json",a=function(t){var e=JSON.parse(t);null!=e&&(o.local=e).hasOwnProperty("show-tutorial-first-time")&&(o["show-tutorial-first-time"]=e["show-tutorial-first-time"])},(n=new XMLHttpRequest).overrideMimeType("application/json"),n.open("GET",e,!1),n.onreadystatechange=function(){4===n.readyState&&200===n.status&&a(n.responseText)},n.send(null))};this.init=function(t){if(t&&t.apiId||console.error("Malabi init() fail - you must supply an object containing the apiId"),!this.isInit){var e,o,a,n,i,r;o=g,a="script",n="ga",(e=p).GoogleAnalyticsObject=n,e.ga=e.ga||function(){(e.ga.q=e.ga.q||[]).push(arguments)},e.ga.l=1*new Date,i=o.createElement(a),r=o.getElementsByTagName(a)[0],i.async=1,i.src="https://www.google-analytics.com/analytics.js",r.parentNode.insertBefore(i,r),ga("create","UA-75726540-1","auto"),ga("send","pageview"),ga(function(t){var e=t.get("clientId");ga("set","dimension1",e)}),this.isInit=!0,this.apiId=t.apiId,null!=t.framework&&(this.framework=t.framework,"bootstrap"!=this.framework&&"Bootstrap"!=this.framework||(this.isBootstrap=!0));var s=g.querySelector('script[src*="Malabi"]');this.settings=t,this.malabiUrl=s.src.substring(0,s.src.indexOf("Malabi")),this.settings.RETURN_IFRAME=1,this.settings.RETURN_EDITOR=2,this.settings.hasOwnProperty("malabiEditorText")&&(this.malabiEditorText=Object.assign(this.malabiEditorText,this.settings.malabiEditorText)),this.settings.hasOwnProperty("transparent")&&1==this.settings.transparent&&(this.transparent=!0),c(this.isBootstrap,this.malabiUrl),t.hasOwnProperty("local")&&(m(t,this),m(t,this)),u(this),t.apiUrl&&(this.apiUrl=t.apiUrl,console.log("API URL set to: "+this.apiUrl))}};var c=function(t,e){t?(a("https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css"),a("https://fonts.googleapis.com/icon?family=Material+Icons"),a("https://fonts.googleapis.com/css?family=Roboto")):(a("https://fonts.googleapis.com/icon?family=Material+Icons"),a("https://cdnjs.cloudflare.com/ajax/libs/materialize/0.97.7/css/materialize.min.css"),a(e+"malabi-editor.css"))},a=function(t){for(var e=g.styleSheets,o=0;o<e.length;o++)if(e[o].href==t)return void console.log(t+" already exist");var a=g.createElement("link");a.setAttribute("href",t),a.setAttribute("rel","stylesheet"),g.head.appendChild(a)},u=function(a){if(!g.getElementById(b)){var n=g.createElement("div");n.id=b,a.isBootstrap?(n.setAttribute("class","modal fade bd-example-modal-lg"),n.setAttribute("tabindex","-1"),n.setAttribute("role","dialog"),n.setAttribute("style","display: none;")):(n.setAttribute("class","modal modal-wider"),n.setAttribute("style","margin-bottom: -8px;display: none;")),g.body.appendChild(n);var i=new XMLHttpRequest;a.isBootstrap?i.open("GET",a.malabiUrl+"modal.bootstrap.html",!0):i.open("GET",a.malabiUrl+"modal.html",!0),i.send(null),i.onreadystatechange=function(){if(4===i.readyState&&200===i.status){var t=i.getResponseHeader("Content-Type");if(1!==t.indexOf("text")){n.innerHTML=i.responseText.trim(),a.settings.hasOwnProperty("local")&&function(t){for(var e in t)t.hasOwnProperty(e)&&(null!=g.getElementById(e)&&(g.getElementById(e).innerText=t[e]),null!=f[e]&&(f[e]=t[e]))}(a.settings.local),l=a.settings.hasOwnProperty("iFrameSrc")&&1<a.settings.iFrameSrc.length?a.settings.iFrameSrc:p.location.protocol+"//d8tv8no6fkiw3.cloudfront.net/version/v4/index.html",r=function(t){var e=t.match(/\/\/(.[^/]+)/);{if(null==e){var o=p.location.href,a=o.split("/");return e=a[0]+"//"+a[2]}return p.location.protocol+"//"+e[1]}}(l),s=g.createElement("iFrame"),a.iframeElement=s;var e=g.getElementById("malabiFrame");null!=e&&void 0!==e||(s.frameBorder=0,s.width="100%",s.height="100%",s.id="malabiFrame",s.setAttribute("src",l),s.style="border:0;",g.getElementById("malabiEditorIFrame").appendChild(s));var o=a;s.addEventListener("load",function(){o.editorFrame=g.getElementById("malabiFrame"),d(o.settings.RETURN_IFRAME),h(),null!=o.settings.onFrameReady&&"function"==typeof o.settings.onFrameReady&&o.settings.onFrameReady(),o.settings&&o.editorFrame.contentWindow.postMessage({initMalabi:JSON.stringify(o.settings)},r),o.settings.hasOwnProperty("backgroundColor")&&o.editorFrame.contentWindow.postMessage({backgroundColor:o.settings.backgroundColor},r),o.injectStyleToIframe&&o.iframeElement.contentDocument.head.appendChild(o.injectStyleToIframe),o.overrideTutorialElement&&(o.iframeElement.contentDocument.getElementById("show-tutorial-first-time").innerHTML="",o.iframeElement.contentDocument.getElementById("show-tutorial-first-time").appendChild(o.overrideTutorialElement))})}}}}},h=function(){var t=g.querySelectorAll('*[id^="malabi-btn"]');if(0<t.length)for(var e=0;e<t.length;e++)o.remove(t[e],"disabled")},n=function(){var t=g.querySelectorAll('*[id^="malabi-btn"]');if(0<t.length)for(var e=0;e<t.length;e++)o.add(t[e],"disabled")};this.edit=function(t,e,o,a){if(!this.isInit)return console.error("please call malabi.init() before calling this function"),!1;if(u(),h(),i.isBootstrap){var n=$("#"+b);n.modal("show"),n.on("hidden.bs.modal",function(t){g.cookie="AWSELB=;expires=Sat, 01-Jan-2000 00:00:00 GMT;",null!=a&&"function"==typeof a&&a()})}else $("#"+b).openModal({complete:function(){g.cookie="AWSELB=;expires=Sat, 01-Jan-2000 00:00:00 GMT;",null!=a&&"function"==typeof a&&a()}});return ga("send","event","Site","open editor","apiId="+this.apiId+"imageId="+t),this.responseOnSave=o&&"function"==typeof o?o:null,this.editorFrame.contentWindow.postMessage({action:"openEditor",apiId:this.apiId,imageId:t,secret:e},r),!0},this.setColor=function(t){return this.editorFrame.contentWindow.postMessage("setColor_"+t,r),1},this.backToEdit=function(){return this.editorFrame.contentWindow.postMessage({action:"backToEdit"},r),1},this.showResult=function(){var t=!1,e=!1;g.getElementById("malabi-show-shadow")&&(t=g.getElementById("malabi-show-shadow").checked),g.getElementById("malabi-show-transparent")&&(e=g.getElementById("malabi-show-transparent").checked);var o={action:"showResult",removeShadow:t,applyTransparent:e};return this.editorFrame.contentWindow.postMessage(o,r),1},this.saveImage=function(){var t=!1,e=!1;g.getElementById("malabi-show-shadow")&&(t=g.getElementById("malabi-show-shadow").checked),g.getElementById("malabi-show-transparent")&&(e=g.getElementById("malabi-show-transparent").checked);var o={action:"saveImage",removeShadow:t,applyTransparent:e};return this.editorFrame.contentWindow.postMessage(o,r),1},this.zoomIn=function(){return this.editorFrame.contentWindow.postMessage("zoomIn",r),1},this.zoomOut=function(){return this.editorFrame.contentWindow.postMessage("zoomOut",r),1},this.onclickLongZoomIn=function(){return this.editorFrame.contentWindow.postMessage("onclickLongZoomIn",r),1},this.onmouseupLongZoomIn=function(){return this.editorFrame.contentWindow.postMessage("onmouseupLongZoomIn",r),1},this.onclickLongZoomOut=function(){return this.editorFrame.contentWindow.postMessage("onclickLongZoomOut",r),1},this.onmouseupLongZoomOut=function(){return this.editorFrame.contentWindow.postMessage("onmouseupLongZoomOut",r),1},this.undo=function(){return this.editorFrame.contentWindow.postMessage("undo",r),1};var i=this;p.addEventListener("message",function(t){if(t.origin===r){var e=t.data;if(0==t.data&&console.log("callbackFuncClose"),t.data.hasOwnProperty("url")&&5<e.url.length&&(h(),i.isBootstrap?$("#"+b).modal("toggle"):$("#"+b).closeModal(),g.cookie="AWSELB=;expires=Sat, 01-Jan-2000 00:00:00 GMT;","function"==typeof i.responseOnSave?i.responseOnSave(JSON.parse(e.url)):console.error("No function to run on save. Implment 'callbackFuncSave', recieves url.")),t.data.hasOwnProperty("loader")&&(1==e.loader&&(n(),g.getElementById("malabi-loader")?g.getElementById("malabi-loader").style.visibility="":console.error("Error Malabi Init: Loader element not found, looking for #malabi-loader element. Or add your override with your own callbackStartLoader function.")),0==e.loader&&d(this.RETURN_EDITOR)),t.data.hasOwnProperty("error")&&(console.error(e),d()),t.data.hasOwnProperty("returnFromShowResult")){if(p.malabi.settings.hasOwnProperty("returnFromShowResult"))return void p.malabi.settings.returnFromShowResult();g.getElementById("malabi-btn-show-result")&&(g.getElementById("malabi-btn-show-result").innerText=f["malabi-btn-show-result"]),h()}t.data.hasOwnProperty("inEditMode")&&(d(),h(),p.malabi.settings.hasOwnProperty("callbackInEditMode")&&p.malabi.settings.callbackInEditMode()),t.data.hasOwnProperty("callbackInShowResult")&&(console.log("callbackInShowResult"),p.malabi.settings.hasOwnProperty("callbackInShowResult")&&p.malabi.settings.callbackInShowResult(),d(),h(),function(){if(g.getElementById("malabi-btn-undo")){var t=g.getElementById("malabi-btn-undo");o.add(t,"disabled")}else console.error("Error Malabi Init: malabi-btn-undo element not found, looking for #malabi-btn-undo element. Or add your override with your own callbackDisableUndo function.")}(),g.getElementById("malabi-btn-show-result")&&(g.getElementById("malabi-btn-show-result").innerText=f["back-to-edit"]))}})};p.waitForSQS=!1,p.malabi=t;var f={"malabi-btn-show-result":"preview result","back-to-edit":"back to edit","tooltip-mark-background":"Draw lines to mark areas you want to remove from the image","tooltip-mark-object":"Draw lines to mark areas you want to keep in the image"};p.malabiEditorText=f;var e=null,y=null}(this,document);
